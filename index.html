<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGR: Process Geometry Renderer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #222;
            color: #ccc;
            font-family: sans-serif;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body>
    <div id="canvas-container"></div>

    <div id="ui-panel">
        <!-- ... existing toolbox content ... -->
        <header>
            <h1>PGR v0.9</h1>
            <div class="header-controls">
                <button id="btn-clear">Clear Scene</button>
            </div>
        </header>

        <section>
            <h3>Primitives</h3>
            <div class="button-grid">
                <button id="btn-add-circle">Circle</button>
                <button id="btn-add-rect">Rect</button>
                <button id="btn-add-line">Line</button>
                <button id="btn-add-poly">Polygon</button>
            </div>
        </section>

        <!-- ... -->

        <section>
            <h3>Text</h3>
            <div class="button-grid">
                <button id="btn-add-text">Add Text</button>
            </div>
        </section>

        <section>
            <h3>Generators</h3>
            <div class="button-grid">
                <button id="btn-gen-grid">Grid Layout</button>
                <button id="btn-gen-radial">Radial Layout</button>
            </div>
            <div class="hint" id="selection-hint">Select an object to generate patterns</div>
        </section>

        <section>
            <h3>Math</h3>
            <div class="button-grid">
                <button id="btn-add-sin">Sin Wave</button>
                <button id="btn-add-cos">Cos Wave</button>
            </div>
        </section>

        <section>
            <h3>Components & Styles</h3>
            <div class="button-grid">
                <button id="btn-create-style">Style</button>
                <button id="btn-create-physics">Physics</button>
                <button id="btn-create-transform">Transform</button>
            </div>
        </section>

        <section>
            <h3>Global Settings</h3>
            <div class="prop-field">
                <label>Background</label>
                <input type="color" id="input-bg-color" value="#222222">
            </div>
        </section>

        <section>
            <h3>Playback</h3>
            <div class="button-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                <button id="btn-play">Play</button>
                <button id="btn-pause">Pause</button>
                <button id="btn-reset">Reset</button>
            </div>
        </section>
    </div>

    <!-- NEW: Right Sidebar (Object List + Property Inspector) -->
    <div id="right-panel">
        <div id="object-list-section">
            <h3>Objects</h3>
            <div id="object-list-content">
                <!-- Dynamic Content -->
            </div>
        </div>

        <!-- Property Panel moved here -->
        <div id="property-panel" class="hidden">
            <h3 id="prop-panel-title">Inspector</h3>
            <div id="prop-fields"></div>

            <!-- JSON I/O Section -->
            <div class="json-section">
                <label>Raw JSON</label>
                <textarea id="prop-json-area" rows="5"></textarea>
                <div class="button-grid" style="margin-top:4px;">
                    <button id="btn-json-load">Load JSON</button>
                    <button id="btn-json-copy">Copy JSON</button>
                </div>
            </div>

            <div class="prop-actions">
                <button id="btn-prop-create" class="primary">Update</button>
                <button id="btn-prop-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <style>
        #ui-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 280px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            font-family: 'Inter', sans-serif;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        #ui-panel h1 {
            font-size: 1.2rem;
            margin: 0 0 16px 0;
            color: #fff;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }

        #ui-panel section {
            margin-bottom: 20px;
        }

        #ui-panel h3 {
            font-size: 0.9rem;
            margin: 0 0 8px 0;
            color: #aaa;
            text-transform: uppercase;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .hint {
            font-size: 0.75rem;
            color: #666;
            margin-top: 4px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        input[type="text"] {
            flex: 1;
            background: #111;
            border: 1px solid #555;
            color: #eee;
            padding: 6px 8px;
            border-radius: 4px;
        }

        button {
            background: #333;
            color: #eee;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s, border-color 0.2s;
        }

        button:hover {
            background: #444;
            border-color: #777;
        }

        button:active {
            background: #222;
        }

        /* Property Panel Styles */
        #property-panel {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #444;
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 4px;
        }

        #property-panel.hidden {
            display: none;
        }

        .prop-field {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prop-field label {
            font-size: 0.8rem;
            color: #aaa;
            margin-right: 8px;
        }

        .prop-field input {
            width: 80px;
            background: #111;
            border: 1px solid #555;
            color: #fff;
            padding: 4px;
            border-radius: 2px;
            text-align: right;
        }

        .prop-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .prop-actions button {
            flex: 1;
        }

        .prop-actions button.primary {
            background: #4a90e2;
            border-color: #357abd;
        }

        button.primary:hover {
            background: #357abd;
        }

        /* Input Group for Refs */
        .prop-input-group {
            display: flex;
            gap: 4px;
            align-items: center;
            width: 100%;
        }

        .prop-input-group input {
            flex: 1;
        }

        .btn-ref-pick {
            padding: 4px 8px;
            font-size: 0.7rem;
            background: #333;
            color: #aaa;
            border: 1px solid #555;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-ref-pick:hover {
            color: #fff;
            border-color: #888;
        }

        /* Ref Picker Modal */
        #ref-picker-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            max-height: 70vh;
            background: #1e1e1e;
            border: 1px solid #555;
            border-radius: 8px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            font-family: 'Inter', sans-serif;
        }

        #ref-picker-modal.hidden {
            display: none;
        }

        .picker-header {
            padding: 12px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #252525;
            border-radius: 8px 8px 0 0;
            font-size: 0.9rem;
            color: #eee;
        }

        .picker-content {
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .picker-obj-group {
            background: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
        }

        .picker-obj-header {
            padding: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #ddd;
            display: flex;
            justify-content: space-between;
        }

        .picker-obj-header:hover {
            background: #333;
        }

        .picker-prop-list {
            display: none;
            background: #222;
            padding: 4px 0;
            border-top: 1px solid #333;
        }

        .picker-prop-list.open {
            display: block;
        }

        .picker-prop-row {
            padding: 4px 16px;
            font-size: 0.8rem;
            color: #888;
            cursor: pointer;
            font-family: monospace;
        }

        .picker-prop-row:hover {
            background: #357abd;
            color: #fff;
        }

        /* Right Panel (Inspector/List) */
        #right-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            font-family: 'Inter', sans-serif;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        #object-list-section {
            border-bottom: 1px solid #444;
            padding-bottom: 16px;
            max-height: 200px;
            /* Scrollable list */
            overflow-y: auto;
        }

        #object-list-section h3 {
            font-size: 0.9rem;
            margin: 0 0 8px 0;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #object-list-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .obj-list-item {
            padding: 4px 8px;
            background: #222;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #ccc;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
        }

        .obj-list-item:hover {
            background: #333;
        }

        .obj-list-item.selected {
            border-color: #4a90e2;
            background: #333;
            color: #fff;
        }

        .obj-list-item .kind-badge {
            font-size: 0.7rem;
            color: #888;
            margin-left: 8px;
            text-transform: uppercase;
        }

        /* JSON Editor */
        .json-section {
            margin-top: 12px;
            border-top: 1px solid #444;
            padding-top: 12px;
        }

        .json-section label {
            font-size: 0.8rem;
            color: #aaa;
            display: block;
            margin-bottom: 4px;
        }

        .json-section textarea {
            width: 100%;
            background: #111;
            color: #0f0;
            font-family: monospace;
            border: 1px solid #444;
            border-radius: 4px;
            resize: vertical;
            font-size: 0.8rem;
            box-sizing: border-box;
        }
    </style>

    <!-- Reference Picker Modal -->
    <div id="ref-picker-modal" class="hidden">
        <div class="picker-header">
            <span>Select Reference</span>
            <button id="btn-picker-close"
                style="background:none; border:none; color:#fff; cursor:pointer; font-size:1.2rem;">&times;</button>
        </div>
        <div id="picker-list" class="picker-content"></div>
    </div>

    <script type="module">
        import * as PGR from './src/index.js';
        import { App } from './src/app.js';

        const sketch = (p) => {
            let app = null;

            p.setup = () => {
                const canvas = p.createCanvas(p.windowWidth, p.windowHeight);
                canvas.parent('canvas-container');
                p.noLoop();

                // Initialize App
                app = new App(p);
                console.log('PGR App Initialized');

                // Bind UI
                bindUI(app);

                // Initial UI Render
                renderObjectList(app);
            };

            p.mousePressed = (e) => {
                // Prevent canvas interaction if clicking UI
                if (e.target.closest('#ui-panel')) return;

                if (app) {
                    // Check if click is on canvas (not on UI)
                    // ... existing logic ...
                    if (p.mouseX >= 0 && p.mouseX <= p.width && p.mouseY >= 0 && p.mouseY <= p.height) {
                        const hitInfo = app.handleMousePressed(p.mouseX, p.mouseY);
                        if (hitInfo && hitInfo.params) {
                            // Valid selection with params -> Open Panel
                            renderPropPanel(app, hitInfo.type, hitInfo.params, true); // true for 'edit mode'
                        } else if (hitInfo) {
                            // Selected but maybe no edit params yet
                        }

                        // Always redraw to show selection state
                        renderEvaluatedObjects(p, app.getRenderList(), app.getSelectedId());
                    }
                }
            };

            p.draw = () => {
                // Draw grid for reference
                PGR.drawGrid(p);

                if (app) {
                    const scene = app.getScene();
                    p.background(scene.background ? scene.background.color : 30); // Set background based on scene or default
                    p.push();
                    // Center origin
                    p.translate(p.width / 2, p.height / 2);

                    // Use sorted execution order for rendering
                    // This ensures dependencies are drawn/evaluated in order
                    const sortedObjects = app.getRenderList();
                    const renderContext = { ...scene, objects: sortedObjects };

                    // Render using PGR scene with sorted objects
                    const result = PGR.renderScene(renderContext, 0);

                    PGR.render(p, result.objects, app.getSelectedId());

                    p.pop();
                } else {
                    p.background(30); // Default background if app is not initialized
                }
            };

            p.windowResized = () => {
                p.resizeCanvas(window.innerWidth, window.innerHeight);
                if (app) app.requestRender();
            };
        };



        function bindUI(app) {
            document.getElementById('btn-clear').onclick = () => app.clearScene();

            // Generic handler for creation buttons
            const openPanel = (type) => {
                const params = app.openCreationPanel(type);
                renderPropPanel(app, type, params);
            };

            document.getElementById('btn-add-circle').onclick = () => openPanel('circle');
            document.getElementById('btn-add-rect').onclick = () => openPanel('rect');
            document.getElementById('btn-add-line').onclick = () => openPanel('line');
            document.getElementById('btn-add-poly').onclick = () => openPanel('polygon');
            document.getElementById('btn-add-text').onclick = () => openPanel('text');

            document.getElementById('btn-gen-grid').onclick = () => openPanel('grid');
            document.getElementById('btn-gen-radial').onclick = () => openPanel('radial');

            // Math Bindings
            document.getElementById('btn-add-sin').onclick = () => openPanel('sin');
            document.getElementById('btn-add-cos').onclick = () => openPanel('cos');

            // Scene Design Bindings
            const bgInput = document.getElementById('input-bg-color');
            if (bgInput) {
                bgInput.oninput = (e) => {
                    app.setBackgroundColor(e.target.value);
                };
            }

            // Component Creation
            document.getElementById('btn-create-style').onclick = () => openPanel('style');
            document.getElementById('btn-create-physics').onclick = () => openPanel('physics');
            document.getElementById('btn-create-transform').onclick = () => openPanel('transform');

            // Playback Bindings
            document.getElementById('btn-play').onclick = () => app.play();
            document.getElementById('btn-pause').onclick = () => app.pause();
            document.getElementById('btn-reset').onclick = () => app.resetTimeline();

            // Panel Actions
            document.getElementById('btn-prop-cancel').onclick = () => {
                document.getElementById('property-panel').classList.add('hidden');
            };

            document.getElementById('btn-prop-create').onclick = () => {
                const panel = document.getElementById('property-panel');
                const mode = panel.dataset.mode;

                // FIX: Include select elements!
                const fields = document.querySelectorAll('.prop-field input, .prop-field select');
                const params = {};
                fields.forEach(f => {
                    params[f.name] = f.value;
                });

                if (mode === 'edit') {
                    app.confirmEdit(params);
                } else {
                    app.confirmCreation(params);
                }

                document.getElementById('property-panel').classList.add('hidden');
                updateSelectionHint(app);
                // Refresh list
                renderObjectList(app);
            };

            // JSON Handlers
            document.getElementById('btn-json-load').onclick = () => {
                const txt = document.getElementById('prop-json-area').value;
                try {
                    const json = JSON.parse(txt);
                    // We need to merge this into the object. 
                    // confirmEdit expects flat params usually? 
                    // Actually confirmEdit merges into scene object.
                    // But confirmEdit might expect specific keys. 
                    // Let's pass the whole object.
                    app.confirmEdit(json);

                    // Refresh UI
                    renderPropPanel(app, json.type, json, true);
                    renderObjectList(app);
                } catch (e) {
                    alert("Invalid JSON: " + e.message);
                }
            };

            document.getElementById('btn-json-copy').onclick = () => {
                const txt = document.getElementById('prop-json-area').value;
                navigator.clipboard.writeText(txt);
            };
        }

        function renderObjectList(app) {
            const container = document.getElementById('object-list-content');
            if (!container) return;
            container.innerHTML = '';

            const scene = app.getScene();
            // Combined list: Objects + Styles + (Components if any in separate lists)
            // For now just Objects + Styles

            const allItems = [];
            if (scene.styles) {
                scene.styles.forEach(s => allItems.push({ ...s, _category: 'Style' }));
            }
            if (scene.objects) {
                scene.objects.forEach(o => allItems.push({ ...o, _category: 'Object' }));
            }
            if (scene.components) {
                scene.components.forEach(c => allItems.push({ ...c, _category: 'Component' }));
            }

            allItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'obj-list-item';
                if (item.id === app.getSelectedId()) {
                    div.classList.add('selected');
                }

                const label = document.createElement('span');
                label.innerText = item.name || item.id;

                const badge = document.createElement('span');
                badge.className = 'kind-badge';
                badge.innerText = (item._category === 'Style') ? 'Style' : item.type;

                div.appendChild(label);
                div.appendChild(badge);

                div.onclick = (e) => {
                    // Prevent propagation to canvas
                    e.stopPropagation();

                    // Select logic
                    if (app.selectById) {
                        app.selectById(item.id);
                    } else {
                        // Fallback or todo: Implement selectById in App
                        console.warn("App.selectById not implemented yet");
                    }

                    // Update UI
                    renderObjectList(app);

                    // Update Prop Panel
                    // We need to fetch params.
                    // If it's a style, params are the style object.
                    // If object, params are object + geometry + transform etc.
                    // App.js should handle extracting params for the panel.
                    // Assuming selectById prepares the 'hitInfo' or we manually invoke renderPropPanel.

                    // If app.selectById sets state, we can query it?
                    // Let's trigger renderPropPanel if we can get the object.
                    const selected = item;
                    renderPropPanel(app, selected.type || 'style', selected, true);
                };

                container.appendChild(div);
            });
        }

        function renderPropPanel(app, type, params, isEdit = false) {
            // ... existing start ...
            const panel = document.getElementById('property-panel');
            const title = document.getElementById('prop-panel-title');
            const container = document.getElementById('prop-fields');
            const btnCreate = document.getElementById('btn-prop-create');

            panel.classList.remove('hidden');
            title.innerText = isEdit ? `Edit ${type}` : `New ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            btnCreate.innerText = isEdit ? 'Update' : 'Create';

            // Store edit mode state
            panel.dataset.mode = isEdit ? 'edit' : 'create';

            // Populate JSON Area
            const jsonArea = document.getElementById('prop-json-area');
            if (jsonArea) {
                // We want the full object if Edit, or defaults if Create.
                // params usually contains the properties.
                jsonArea.value = JSON.stringify(params, null, 2);
            }

            container.innerHTML = '';
            // ... rest of rendering ...

            // 1. Display ID (Edit Mode Only)
            if (isEdit) {
                const idDiv = document.createElement('div');
                idDiv.className = 'prop-field';
                idDiv.style.borderBottom = '1px solid #444';
                idDiv.style.paddingBottom = '5px';
                idDiv.style.marginBottom = '10px';
                const label = document.createElement('label');
                label.innerText = 'ID';
                const span = document.createElement('span');
                span.innerText = app.getSelectedId();
                span.style.fontFamily = 'monospace';
                span.style.color = '#88ff88';
                idDiv.appendChild(label);
                idDiv.appendChild(span);
                container.appendChild(idDiv);
            }

            // 2. Render Fields
            // Group Physics?
            // Simple iteration first, special check for styleId

            for (const [key, value] of Object.entries(params)) {
                if (key === 'type') continue;

                const div = document.createElement('div');
                div.className = 'prop-field';

                const label = document.createElement('label');
                // Use nicer labels
                label.innerText = key === 'moveX' ? 'Delta X' : key === 'moveY' ? 'Delta Y' : key;

                let input;
                if (key === 'styleId') {
                    // Style Dropdown
                    input = document.createElement('select');
                    input.name = key;

                    // Default/Local Option
                    const defOpt = document.createElement('option');
                    defOpt.value = '';
                    defOpt.innerText = '(Local/None)';
                    input.appendChild(defOpt);

                    const styles = app.getStyles();
                    styles.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.innerText = s.name || s.id;
                        if (s.id === value) opt.selected = true;
                        input.appendChild(opt);
                    });
                } else {
                    input = document.createElement('input');
                    input.name = key;
                    input.value = value;
                    if (typeof value === 'number') input.type = 'number';
                    else input.type = 'text';

                    // Placeholder for references
                    if (key.startsWith('input') || key === 'radius' || key === 'x' || key === 'y') {
                        input.placeholder = "Value or @Obj.Prop";
                    }
                }

                div.appendChild(label);
                div.appendChild(input);
                container.appendChild(div);
            }
        }

        function updateSelectionHint(app) {
            const hint = document.getElementById('selection-hint');
            if (app.getSelectedId()) {
                hint.innerText = "Active Object: " + app.getSelectedId();
                hint.style.color = "#88cc88";
            } else {
                hint.innerText = "Select an object to generate patterns";
                hint.style.color = "#cc8888";
            }
        }

        new p5(sketch, document.getElementById('canvas-container'));
    </script>
</body>

</html>